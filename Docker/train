## here you should call the task(s) that you want to run as default using the following syntax (preferable to a symbolic link)
# . "$DCKR_TASKS"/mytask1
#echo 'Default task is empty' 1>&2
#check if list of input files exist
if [ ! -f "$CONT_CONTIGS_FILE_LISTING" ]
then
	echo "List of input files not given. Please include a list of input files at: $CONT_CONTIGS_FILE_LISTING" 1>&2
	exit 0
fi

#check if Data folder is present
if [ ! -d /dckr/mnt/input ]
then
	echo "Data directory missing. Hint, include the following command when starting docker: -v /path/to/local/Data:/dckr/mnt/input:ro" 1>&2
	exit 0
fi

#check if names, nodes, and gi_taxid_nucl.dmp exist
if [ ! -f /dckr/mnt/input/names.dmp ]
then
	echo "Missing names.dmp from input folder"
	exit 0
fi
if [ ! -f /dckr/mnt/input/nodes.dmp ]
then
	echo "Missing nodes.dmp from input folder"
	exit 0
fi
if [ ! -f /dckr/mnt/input/gi_taxid_nucl.dmp ]
then
	echo "Missing gi_taxid_nucl.dmp from input folder"
	exit 0
fi

#Create output
mkdir /dckr/mnt/output/Database
mkdir /dckr/mnt/output/Database/taxonomy
mkdir /dckr/mnt/output/Database/library
cp /dckr/mnt/input/names.dmp /dckr/mnt/output/Database/taxonomy
cp /dckr/mnt/input/nodes.dmp /dckr/mnt/output/Database/taxonomy
cp /dckr/mnt/input/gi_taxid_nucl.dmp /dckr/mnt/output/Database/taxonomy

#Add all files to Kraken training database
cat $CONT_CONTIGS_FILE_LISTING | xargs -I{} /kraken-0.10.5-beta/./kraken-build --add-to-library {} --db /dckr/mnt/output/Database

#Build the Kraken database
/kraken-0.10.5-beta/./kraken-build --build --db /dckr/mnt/output/Database --threads ${DCKR_THREADS}

#Build the taxonomy
cd /tmp
tar -czf NamesAndNodes.tar.gz /dckr/mnt/input/names.dmp /dckr/mnt/input/nodes.dmp
python /usr/local/sbin/generate_taxonomy_taxid.py --ncbi_taxdump file:///temp/NamesAndNodes.tar.gz --output taxonomy_taxID.txt
cut -f2 /dckr/mnt/output/Database/seq2taxid.map | sort -u | LC_ALL=C xargs -I{} grep -m1 "^{}_" taxonomy_taxID.txt > /dckr/mnt/output/Database/taxonomy_taxID_Kraken.txt


